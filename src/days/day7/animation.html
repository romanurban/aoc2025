<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Day 7 · Laser Beam Splitter</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Chivo+Mono:wght@500;600&display=swap');
    :root {
      --laser: #ff3366;
      --laser-glow: rgba(255, 51, 102, 0.6);
      --splitter: #00ffcc;
      --splitter-glow: rgba(0, 255, 204, 0.5);
      --bg: #050711;
      --panel: rgba(8, 12, 24, 0.92);
      --border: rgba(255, 255, 255, 0.16);
      --text: #eef6ff;
      --muted: #9ab2c9;
      --mono: 'Chivo Mono', 'DM Mono', 'Space Mono', monospace;
      --sans: 'Space Grotesk', 'Inter', system-ui, sans-serif;
      --radius: 18px;
      --cell-size: 32px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      font-family: var(--sans);
      color: var(--text);
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .stars {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(2px 2px at 20px 30px, #fff, transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 90px 40px, #fff, transparent),
        radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent),
        radial-gradient(1px 1px at 230px 80px, #fff, transparent),
        radial-gradient(2px 2px at 300px 160px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 380px 60px, #fff, transparent),
        radial-gradient(2px 2px at 450px 200px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 520px 100px, #fff, transparent),
        radial-gradient(2px 2px at 600px 180px, rgba(255,255,255,0.6), transparent);
      background-size: 650px 250px;
      animation: twinkle 8s ease-in-out infinite alternate;
      z-index: -1;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .container {
      display: flex;
      gap: 24px;
      padding: 24px;
      max-width: 100vw;
      flex-wrap: wrap;
      justify-content: center;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow:
        0 24px 60px rgba(0, 0, 0, 0.52),
        inset 0 1px 0 rgba(255,255,255,0.05);
      padding: 20px;
      backdrop-filter: blur(12px);
    }
    .header {
      margin-bottom: 16px;
    }
    .eyebrow {
      color: var(--muted);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 10px;
    }
    h1 {
      margin: 4px 0 0;
      font-size: 22px;
      background: linear-gradient(90deg, var(--laser), #ff6699, var(--splitter));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .stats {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    .stat .label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .stat .value {
      font-family: var(--mono);
      font-size: 24px;
      margin-top: 4px;
    }
    .stat .value.laser { color: var(--laser); text-shadow: 0 0 20px var(--laser-glow); }
    .stat .value.splitter { color: var(--splitter); text-shadow: 0 0 20px var(--splitter-glow); }
    .grid-container {
      position: relative;
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      overflow: hidden;
    }
    .grid {
      display: grid;
      gap: 2px;
      position: relative;
    }
    .cell {
      width: var(--cell-size);
      height: var(--cell-size);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--mono);
      font-size: 14px;
      border-radius: 4px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      position: relative;
      transition: background 0.2s, border-color 0.2s;
    }
    .cell.start {
      background: rgba(255, 51, 102, 0.2);
      border-color: var(--laser);
      color: var(--laser);
      font-weight: bold;
    }
    .cell.splitter {
      background: rgba(0, 255, 204, 0.15);
      border-color: var(--splitter);
      color: var(--splitter);
      font-weight: bold;
    }
    .cell.visited {
      background: rgba(255, 51, 102, 0.1);
    }
    .beam {
      position: absolute;
      background: var(--laser);
      box-shadow: 0 0 12px var(--laser-glow), 0 0 24px var(--laser-glow);
      border-radius: 2px;
      z-index: 10;
      pointer-events: none;
    }
    .beam.vertical {
      width: 4px;
      height: 0;
      left: 50%;
      transform: translateX(-50%);
    }
    .beam.diagonal-left {
      width: 4px;
      height: 0;
      transform-origin: top center;
      transform: rotate(-45deg);
    }
    .beam.diagonal-right {
      width: 4px;
      height: 0;
      transform-origin: top center;
      transform: rotate(45deg);
    }
    .split-flash {
      position: absolute;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, var(--splitter) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      animation: flash 0.4s ease-out forwards;
      pointer-events: none;
      z-index: 20;
    }
    @keyframes flash {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
    }
    .controls {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    button {
      flex: 1;
      border: 1px solid rgba(255,255,255,0.16);
      background: linear-gradient(120deg, var(--laser), #ff6699);
      color: #fff;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 8px 24px rgba(255, 51, 102, 0.3);
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(255, 51, 102, 0.4); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    button.secondary {
      background: rgba(255,255,255,0.1);
      box-shadow: none;
    }
    button.secondary:hover { box-shadow: 0 8px 24px rgba(255,255,255,0.1); }
    .speed-control {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
    }
    .speed-control input {
      flex: 1;
      accent-color: var(--laser);
    }
    .legend {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      font-size: 11px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .legend-dot.laser { background: var(--laser); box-shadow: 0 0 8px var(--laser-glow); }
    .legend-dot.splitter { background: var(--splitter); box-shadow: 0 0 8px var(--splitter-glow); }
    .timeline-display {
      margin-top: 16px;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .timeline-display .title {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 8px;
    }
    .timeline-bar {
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
    }
    .timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--laser);
      box-shadow: 0 0 6px var(--laser-glow);
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    /* Mobile responsive styles */
    @media (max-width: 600px) {
      :root {
        --cell-size: 18px;
        --radius: 12px;
      }
      body {
        align-items: flex-start;
        overflow-y: auto;
        overflow-x: hidden;
      }
      .container {
        padding: 12px;
        gap: 12px;
      }
      .panel {
        padding: 14px;
        width: 100%;
        max-width: 100vw;
      }
      .header {
        margin-bottom: 12px;
      }
      .eyebrow {
        font-size: 9px;
      }
      h1 {
        font-size: 18px;
      }
      .stats {
        gap: 8px;
        margin-bottom: 12px;
      }
      .stat {
        padding: 8px 6px;
        border-radius: 8px;
      }
      .stat .label {
        font-size: 8px;
      }
      .stat .value {
        font-size: 18px;
      }
      .grid-container {
        padding: 10px;
        border-radius: 10px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .grid {
        gap: 1px;
      }
      .cell {
        font-size: 10px;
        border-radius: 2px;
      }
      .beam {
        width: 3px;
        box-shadow: 0 0 8px var(--laser-glow);
      }
      .split-flash {
        width: 40px;
        height: 40px;
      }
      .controls {
        gap: 8px;
        margin-top: 12px;
      }
      button {
        padding: 10px 14px;
        font-size: 13px;
        border-radius: 10px;
      }
      .speed-control {
        margin-top: 10px;
        font-size: 11px;
      }
      .legend {
        gap: 12px;
        margin-top: 10px;
        font-size: 10px;
      }
      .legend-dot {
        width: 10px;
        height: 10px;
      }
      .timeline-display {
        margin-top: 12px;
        padding: 10px;
        border-radius: 10px;
      }
      .timeline-display .title {
        font-size: 9px;
      }
      .timeline-dot {
        width: 6px;
        height: 6px;
      }
    }

    @media (max-width: 380px) {
      :root {
        --cell-size: 14px;
      }
      .panel {
        padding: 10px;
      }
      h1 {
        font-size: 16px;
      }
      .stat .value {
        font-size: 16px;
      }
      .cell {
        font-size: 8px;
      }
      button {
        padding: 8px 10px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="container">
    <div class="panel">
      <div class="header">
        <p class="eyebrow">Day 7 · Quantum Optics</p>
        <h1>Laser Beam Splitter</h1>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="label">Splits</div>
          <div class="value laser" id="splitCount">0</div>
        </div>
        <div class="stat">
          <div class="label">Timelines</div>
          <div class="value splitter" id="timelineCount">1</div>
        </div>
        <div class="stat">
          <div class="label">Row</div>
          <div class="value" id="currentRow" style="color: var(--text);">0</div>
        </div>
      </div>

      <div class="grid-container">
        <div class="grid" id="grid"></div>
      </div>

      <div class="controls">
        <button id="startBtn">Start Simulation</button>
        <button id="resetBtn" class="secondary">Reset</button>
      </div>

      <div class="speed-control">
        <span>Speed:</span>
        <input type="range" id="speedSlider" min="50" max="500" value="200" />
        <span id="speedLabel">200ms</span>
      </div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-dot laser"></div>
          <span>Laser beam</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot splitter"></div>
          <span>Splitter (^)</span>
        </div>
      </div>

      <div class="timeline-display">
        <div class="title">Active Timelines</div>
        <div class="timeline-bar" id="timelineBar"></div>
      </div>
    </div>
  </div>

  <script>
    const puzzleInput = `.......S.......
...............
.......^.......
...............
......^.^......
...............
.....^.^.^.....
...............
....^.^...^....
...............
...^.^...^.^...
...............
..^...^.....^..
...............
.^.^.^.^.^...^.
...............`;

    const state = {
      grid: [],
      beams: [], // { row, col, count }
      splitCount: 0,
      running: false,
      timer: null,
      speed: 200,
      currentRow: 0,
    };

    const els = {
      grid: document.getElementById('grid'),
      splitCount: document.getElementById('splitCount'),
      timelineCount: document.getElementById('timelineCount'),
      currentRow: document.getElementById('currentRow'),
      startBtn: document.getElementById('startBtn'),
      resetBtn: document.getElementById('resetBtn'),
      speedSlider: document.getElementById('speedSlider'),
      speedLabel: document.getElementById('speedLabel'),
      timelineBar: document.getElementById('timelineBar'),
    };

    function parseGrid(input) {
      return input.trim().split('\n').map(line => line.split(''));
    }

    function renderGrid() {
      const grid = state.grid;
      const height = grid.length;
      const width = grid[0].length;

      els.grid.style.gridTemplateColumns = `repeat(${width}, var(--cell-size))`;
      els.grid.innerHTML = '';

      for (let row = 0; row < height; row++) {
        for (let col = 0; col < width; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = row;
          cell.dataset.col = col;

          const ch = grid[row][col];
          if (ch === 'S') {
            cell.classList.add('start');
            cell.textContent = 'S';
          } else if (ch === '^') {
            cell.classList.add('splitter');
            cell.textContent = '^';
          }

          els.grid.appendChild(cell);
        }
      }
    }

    function getCell(row, col) {
      return els.grid.querySelector(`[data-row="${row}"][data-col="${col}"]`);
    }

    function createBeamElement(row, col, direction = 'vertical') {
      const cell = getCell(row, col);
      if (!cell) return null;

      const beam = document.createElement('div');
      beam.className = `beam ${direction}`;
      cell.appendChild(beam);
      return beam;
    }

    function animateBeam(beam, targetHeight, duration) {
      return new Promise(resolve => {
        beam.style.transition = `height ${duration}ms linear`;
        requestAnimationFrame(() => {
          beam.style.height = `${targetHeight}px`;
        });
        setTimeout(resolve, duration);
      });
    }

    function createSplitFlash(row, col) {
      const cell = getCell(row, col);
      if (!cell) return;

      const flash = document.createElement('div');
      flash.className = 'split-flash';
      flash.style.left = '50%';
      flash.style.top = '50%';
      cell.appendChild(flash);

      setTimeout(() => flash.remove(), 400);
    }

    function updateStats() {
      els.splitCount.textContent = state.splitCount;
      const totalTimelines = state.beams.reduce((sum, b) => sum + b.count, 0);
      els.timelineCount.textContent = totalTimelines || 1;
      els.currentRow.textContent = state.currentRow;

      // Update timeline bar
      els.timelineBar.innerHTML = '';
      for (let i = 0; i < Math.min(totalTimelines, 50); i++) {
        const dot = document.createElement('div');
        dot.className = 'timeline-dot';
        dot.style.animationDelay = `${i * 0.1}s`;
        els.timelineBar.appendChild(dot);
      }
      if (totalTimelines > 50) {
        const more = document.createElement('span');
        more.style.color = 'var(--muted)';
        more.style.fontSize = '10px';
        more.style.marginLeft = '8px';
        more.textContent = `+${totalTimelines - 50} more`;
        els.timelineBar.appendChild(more);
      }
    }

    function init() {
      state.grid = parseGrid(puzzleInput);
      state.beams = [];
      state.splitCount = 0;
      state.currentRow = 0;
      state.running = false;

      // Find starting position
      for (let col = 0; col < state.grid[0].length; col++) {
        if (state.grid[0][col] === 'S') {
          state.beams.push({ row: 0, col, count: 1 });
        }
      }

      renderGrid();
      updateStats();

      els.startBtn.disabled = false;
      els.startBtn.textContent = 'Start Simulation';
    }

    async function simulateStep() {
      if (!state.running) return;

      const height = state.grid.length;
      const width = state.grid[0].length;
      const currentRow = state.currentRow;

      if (currentRow >= height - 1) {
        state.running = false;
        els.startBtn.disabled = false;
        els.startBtn.textContent = 'Simulation Complete';
        return;
      }

      // Process all beams at current row
      const nextBeams = [];

      for (const beam of state.beams) {
        if (beam.row !== currentRow) continue;

        const nextRow = currentRow + 1;
        const nextCell = state.grid[nextRow][beam.col];

        // Mark current cell as visited
        const cell = getCell(beam.row, beam.col);
        if (cell) cell.classList.add('visited');

        // Create visual beam
        const beamEl = createBeamElement(beam.row, beam.col, 'vertical');
        if (beamEl) {
          const cellSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size'));
          await animateBeam(beamEl, cellSize + 2, state.speed / 2);
        }

        if (nextCell === '^') {
          // Split!
          state.splitCount++;
          createSplitFlash(nextRow, beam.col);

          // Left diagonal
          if (beam.col - 1 >= 0) {
            nextBeams.push({ row: nextRow, col: beam.col - 1, count: beam.count });
            const leftCell = getCell(nextRow, beam.col - 1);
            if (leftCell) leftCell.classList.add('visited');
          }

          // Right diagonal
          if (beam.col + 1 < width) {
            nextBeams.push({ row: nextRow, col: beam.col + 1, count: beam.count });
            const rightCell = getCell(nextRow, beam.col + 1);
            if (rightCell) rightCell.classList.add('visited');
          }
        } else {
          // Continue straight down
          nextBeams.push({ row: nextRow, col: beam.col, count: beam.count });
          const downCell = getCell(nextRow, beam.col);
          if (downCell) downCell.classList.add('visited');
        }
      }

      // Merge beams at same position
      const merged = new Map();
      for (const beam of nextBeams) {
        const key = `${beam.row},${beam.col}`;
        if (merged.has(key)) {
          merged.get(key).count += beam.count;
        } else {
          merged.set(key, { ...beam });
        }
      }

      state.beams = Array.from(merged.values());
      state.currentRow = currentRow + 1;

      updateStats();

      // Continue simulation
      state.timer = setTimeout(simulateStep, state.speed);
    }

    function start() {
      if (state.running) {
        state.running = false;
        clearTimeout(state.timer);
        els.startBtn.textContent = 'Resume';
        return;
      }

      state.running = true;
      els.startBtn.textContent = 'Pause';
      simulateStep();
    }

    function reset() {
      state.running = false;
      clearTimeout(state.timer);
      init();
    }

    els.startBtn.addEventListener('click', start);
    els.resetBtn.addEventListener('click', reset);

    els.speedSlider.addEventListener('input', (e) => {
      state.speed = 550 - parseInt(e.target.value);
      els.speedLabel.textContent = `${state.speed}ms`;
    });

    // Initialize
    init();
  </script>
</body>
</html>
